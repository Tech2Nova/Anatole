<!doctype html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  
    class="html theme--light"
  
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <title>
    
      
        Setup KVM |
      Chenxi Dang

  </title>

  <meta name="generator" content="Hugo 0.152.2"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Chenxi Dang" />
  <meta
    name="description"
    content="在 Ubuntu 主机中搭建 KVM 环境，并安装 QEMU Guest Agent"
  />
  
  
        <link rel="stylesheet" href="/css/anatole.css" />
      
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.10cb17328b3207590ce3d89fb482e7cd6937d8138cef2059c69cabd65ab7d6c6.css"
    integrity="sha256-EMsXMosyB1kM49iftILnzWk32BOM7yBZxpyr1lq31sY="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.7aa4d559d5fadcfed666b5679be54d0dbbcf6a0542742319765b253d2797cc44.css"
    integrity="sha256-eqTVWdX63P7WZrVnm&#43;VNDbvPagVCdCMZdlslPSeXzEQ="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.a699c3ab02229020e2d51dfe6c9a4cc556fd7781edbc166e2af9d0db9d5c66ce.css"
    integrity="sha256-ppnDqwIikCDi1R3&#43;bJpMxVb9d4HtvBZuKvnQ251cZs4="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.1d88b60c86c4bb253fa4d4c085d27f7ee1f6eca544f7b50b227a2e63fbcfbaaa.css"
    integrity="sha256-HYi2DIbEuyU/pNTAhdJ/fuH27KVE97ULInouY/vPuqo="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />

  <link rel="canonical" href="http://localhost:1313/post/setup-kvm/" />
  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js"
    integrity="sha256-&#43;RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.8724ddf9268dee451060f191961647573c7f592fbccc6d858746236b3f915813.js"
      integrity="sha256-hyTd&#43;SaN7kUQYPGRlhZHVzx/WS&#43;8zG2Fh0Yjaz&#43;RWBM="
      crossorigin="anonymous"
    ></script>
  

  

  

  


  
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/images/site-feature-image.png">
  <meta name="twitter:title" content="Setup KVM">
  <meta name="twitter:description" content="在 Ubuntu 主机中搭建 KVM 环境，并安装 QEMU Guest Agent">



  
  <meta property="og:url" content="http://localhost:1313/post/setup-kvm/">
  <meta property="og:site_name" content="My blog">
  <meta property="og:title" content="Setup KVM">
  <meta property="og:description" content="在 Ubuntu 主机中搭建 KVM 环境，并安装 QEMU Guest Agent">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-03-30T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-03-30T00:00:00+00:00">
    <meta property="og:image" content="http://localhost:1313/images/site-feature-image.png">



  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "post",
        "name": "Setup KVM",
        "headline": "Setup KVM",
        "alternativeHeadline": "",
        "description": "
      在 Ubuntu 主机中搭建 KVM 环境，并安装 QEMU Guest Agent


    ",
        "license": "",
        
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/post\/setup-kvm\/"
        },
        "author" : {
            "@type": "Person",
            "name": "chenxi"
        },
        "creator" : {
            "@type": "Person",
            "name": "chenxi"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "chenxi"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "chenxi"
        },
        "dateCreated": "2025-03-30T00:00:00.00Z",
        "datePublished": "2025-03-30T00:00:00.00Z",
        "dateModified": "2025-03-30T00:00:00.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "chenxi",
            "url": "http://localhost:1313/",
            "logo": {
                "@type": "ImageObject",
                "url": "http:\/\/localhost:1313\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
        
        "http://localhost:1313/images/site-feature-image.png"


      
      ]

    ,
        "url" : "http:\/\/localhost:1313\/post\/setup-kvm\/",
        "wordCount" : "309",
        "genre" : [ 
      
      "Blog"

    ],
        "keywords" : [ ]
    }
  </script>




  
  
  
</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/images/profile.jpg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">I&#39;m Chenxi Dang</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>Call me Chenxi</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/Tech2Nova/"
            target="_blank"
            rel="noopener me"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fa-brands fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="mailto:Dangchenxi650@163.com"
            target="_blank"
            rel="noopener me"
            aria-label="e-mail"
            title="e-mail"
          >
            <i class="fa-solid fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://weixin.qq.com/"
            target="_blank"
            rel="noopener me"
            aria-label="WeChat"
            title="WeChat"
          >
            <i class="fa-brands fa-weixin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://www.bilibili.com/"
            target="_blank"
            rel="noopener me"
            aria-label="Bilibili"
            title="Bilibili"
          >
            <i class="fa-brands fa-bilibili fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Chenxi Dang
        2025
      
    </li>
    
      <li class="footer__item">
        <a
          class="link"
          href="/imprint/"
          
          title=""
        >
          imprint
        </a>
      </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.9531b4a2217a70c5a1fce89c1f81c9ebbdd586708fcd4130b417320c7230c8d6.js"
    integrity="sha256-lTG0oiF6cMWh/OicH4HJ673VhnCPzUEwtBcyDHIwyNY="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/post/"
              
              title=""
              >Posts</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/categories/"
              
              title=""
              >categories</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/work/"
              
              title=""
              >Work Experience</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
        <li class="nav__list-item">
          <div class="optionswitch">
            <input class="optionswitch__picker" type="checkbox" id="languagepicker" hidden />
            <label class="optionswitch__label" for="languagepicker"
              >English <i class="fa fa-angle-down" aria-hidden="true"></i
            ></label>
            <div class="optionswitch__triangle"></div>
            <ul class="optionswitch__list">
              
                <li class="optionswitch__list-item">
                  <a href="/zh/post/setup-kvm/" title="中文（简体）"
                    ><span
                      
                      aria-label="中文（简体）"
                      >中文（简体）</span
                    >
                  </a>
                </li>
              
            </ul>
          </div>
        </li>
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      
        <h1>Setup KVM</h1>
      
      
        <ul class="post__meta">
          <li class="post__meta-item">
            <em class="fas fa-calendar-day post__meta-icon"></em>
            <span class="post__meta-text"
              >
                
                  30/3/2025
                

              
            </span>
          </li>
          <li class="post__meta-item">
            <em class="fas fa-stopwatch post__meta-icon"></em>
            <span class="post__meta-text">2-minute read</span>
          </li>
        </ul>
      <p>在 Ubuntu 16.04（或更高版本）上完整搭建 KVM 虚拟化环境，创建 Windows 7 客户机，安装 Virtio 驱动和 QEMU Guest Agent，实现优雅关机、guest-ping 等高级功能。</p>
<h3 id="搭建kvm环境安装qemu-guest-agent">搭建KVM环境、安装qemu guest agent</h3>
<h4 id="1配置环境说明">1、配置环境说明</h4>
<p>物理主机：Windows11，Intel Core i7-13650HX，VMware Workstation 16 Pro</p>
<p>VMware客户机：Ubuntu16.04</p>
<p>KVM客户机：Windows7 ultimate</p>
<p>注：物理主机要使用Intel处理器，AMD会出现不兼容的问题；KVM客户机可使用Win7，也可以使用Win7旗舰版，提前准备好iso镜像文件</p>
<h4 id="2安装kvm">2、安装KVM</h4>
<h5 id="21-虚拟化技术">2.1 虚拟化技术</h5>
<p>我们通常所说的虚拟化主要是指平台虚拟化技术，通过使⽤控制程序（Control Program，也被称为  Virtual Machine Monitor 或Hypervisor），隐藏特定计算平台的实际物理特性，为⽤户提供抽象的、统 ⼀的、模拟的计算环境（称为虚拟机）。虚拟机中运⾏的操作系统被称为客户机操作系统（Guest  OS），运⾏虚拟机监控器的操作系统被称为主机操作系统（Host OS），当然某些虚拟机监控器可以脱 离操作系统直接运⾏在硬件之上（如 VMWARE 的 ESX 产品）。</p>
<h5 id="21-kvm介绍">2.1 KVM介绍</h5>
<p>KVM 全称是基于内核的虚拟机（Kernel-based Virtual Machine），它是一个 Linux 的一个内核模块，该内核模块使得 Linux 变成了一个 Hypervisor：</p>
<ul>
<li>它由 Quramnet 开发，该公司于 2008年被 Red Hat 收购。</li>
<li>它支持 x86 (32 and 64 位), s390, Powerpc 等 CPU。</li>
<li>它从 Linux 2.6.20 起就作为一模块被包含在 Linux 内核中。</li>
<li>它需要支持虚拟化扩展的 CPU（即支持Intel VT 或者 AMD-V）。</li>
<li>它是完全开源的。</li>
</ul>
<p><strong>KVM 中，虚拟机被实现为常规的 Linux 进程，由标准 Linux 调度程序进行调度</strong>；虚机的每个虚拟 CPU 被实现为一个常规的 Linux 进程。这使得 KMV 能够使用 Linux 内核的已有功能。但是，KVM 本身不执行任何硬件模拟，需要客户空间程序通过 /dev/kvm 接口设置一个客户机虚拟服务器的地址空间，向它提供模拟的 I/O，并将它的视频显示映射回宿主的显示屏。目前这个应用程序是 QEMU。</p>
<figure><img src="/images/KVM/137038861_1_20180629063610565.jpeg"
    alt="KVM architecture" width="50%"><figcaption>
      <p>KVM 整体架构图</p>
    </figcaption>
</figure>

<ul>
<li>KVM：运行在内核空间，提供CPU 和内存的虚级化，以及客户机的 I/O 拦截。Guest 的 I/O 被 KVM 拦截后，交给 QEMU 处理。</li>
<li>QEMU：修改过的为 KVM 虚机使用的 QEMU 代码，运行在用户空间，提供硬件 I/O 虚拟化，通过 IOCTL /dev/kvm 设备和 KVM 交互。</li>
<li>libvirt：是调用kvm虚拟化技术的接口用于管理的</li>
<li>虚拟机配置文件，XML文件，位置 ：/etc/libvirt/qemu/</li>
<li>虚拟机硬盘文件，默认位置：/var/lib/libvirt/images/</li>
</ul>
<h5 id="22-vmware设置">2.2 VMware设置</h5>
<p>（1）按照自身电脑配置设置Ubuntu的硬件参数，内存至少在4GB以上，硬盘越大越好，至少在60GB以上</p>
<p>（2）-&gt;编辑虚拟机设置-&gt;处理器-&gt;虚拟化引擎，这里要勾选虚拟化Intel VT-x/EPT或AMD-V/RVI(V)</p>
<figure><img src="/images/KVM/Snipaste_2024-12-10_10-06-49.png" width="33%">
</figure>

<p>但是勾选这个可能会出现虚拟机无法开机的问题</p>
<figure><img src="/images/KVM/unsupport-intel-vt-x.webp" width="50%">
</figure>

<p>这是因为微软的 Hyper-V 与 VMware Workstation 之间是冲突的，所以你不能二者兼得。因此，如果你要在 VMware 中使用英特尔虚拟化技术，就必须要舍弃 Hyper-V。</p>
<p>如果电脑是win11专业版，可以在网上搜索编辑组策略的方法解决、并在Windows功能界面，将Hyper-V相关的选项全部取消勾选</p>
<figure><img src="/images/KVM/d2d8746b6b798841a80efbc2fbb77636.png" width="50%">
</figure>

<p>如果电脑是win11家庭版，需要以管理员身份打开shellcode，运行以下代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">bcdedit /set hypervisorlaunchtype off
</span></span></code></pre></div><p>并关闭所有Hyper-V相关的服务</p>
<p><figure><img src="/images/KVM/image-20241210105536041.png" width="50%">
</figure>

如果以上措施还是无法解决问题，可以参考以下博客尝试解决</p>
<p><a href="https://blog.51cto.com/xiaobinbin/5286998">https://blog.51cto.com/xiaobinbin/5286998</a></p>
<p><a href="https://www.cnblogs.com/never-say-die/p/16840030.html">https://www.cnblogs.com/never-say-die/p/16840030.html</a></p>
<h5 id="23-安装kvm">2.3 安装KVM</h5>
<p>（1）首先看看cpu是否支持kvm虚拟化：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">egrep -c <span class="s2">&#34;(svm|vmx)&#34;</span> /proc/cpuinfo
</span></span></code></pre></div><figure><img src="/images/KVM/Snipaste_2024-12-09_11-42-27.png" width="80%">
</figure>

<p>返回结果大于0即可</p>
<p>（2）安装KVM及相关依赖包</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt-get install qemu-kvm qemu virt-manager virt-viewer libvirt-bin bridge-utils
</span></span></code></pre></div><p>（3） 启用桥接网络</p>
<p>先备份一套原有配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp /etc/network/interfaces /etc/network/interfaces-bak
</span></span></code></pre></div><p>对/etc/network/interfaces 配置文件进行更改</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gedit /etc/network/interfaces
</span></span></code></pre></div><p>将以下内容粘贴复制到文件中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl"># Enabing Bridge networking br0 interface
</span></span><span class="line"><span class="cl">auto br0
</span></span><span class="line"><span class="cl">iface br0 inet static
</span></span><span class="line"><span class="cl">address 192.168.1.130
</span></span><span class="line"><span class="cl">network 192.168.1.0
</span></span><span class="line"><span class="cl">netmask 255.255.255.0
</span></span><span class="line"><span class="cl">broadcast 192.168.1.255
</span></span><span class="line"><span class="cl">#gateway 192.168.1.1   设置网关后， 191.168.1.1 权重是0 在第一位，系统重启后可能无法联网，所以我删掉了这个网关
</span></span><span class="line"><span class="cl">dns-nameservers 223.5.5.5
</span></span><span class="line"><span class="cl">bridge_ports eth0
</span></span><span class="line"><span class="cl">bridge_stp off
</span></span></code></pre></div><p>（4）重启虚拟机  reboot，然后使用ifconfig查看网络配置</p>
<figure><img src="/images/KVM/Snipaste_2024-12-09_18-13-12.png" width="80%">
</figure>

<p>（5） 启动KVM虚拟系统管理器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo virt-manager
</span></span></code></pre></div><figure><img src="/images/KVM/Snipaste_2024-12-09_18-13-58.png" width="80%">
</figure>

<h4 id="3安装qemu-guest-agent">3、安装qemu guest agent</h4>
<h5 id="31-virtio驱动">3.1 Virtio驱动</h5>
<p>Virtio驱动程序是KVM虚拟机的半虚拟化设备驱动程序，半虚拟化驱动程序可提高机器性能，减少I / O延迟并将吞吐量提高到接近裸机水平，对于完全虚拟化的计算机，建议使用半虚拟化驱动程序。</p>
<p>这是虚拟机内部代理的基础。</p>
<p>virtio-win-0.1.171： <a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.171-1/">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.171-1/</a></p>
<p>提前下载好放在ubuntu中</p>
<h5 id="32-安装win7客户机">3.2 安装win7客户机</h5>
<p>（1）点击文件-&gt;新建虚拟机 （类似VMware）</p>
<p><figure><img src="/images/KVM/Snipaste_2024-12-09_18-14-35.png" width="250px">
</figure>

<figure><img src="/images/KVM/Snipaste_2024-12-09_18-20-24.png" width="250px">
</figure>

<figure><img src="/images/KVM/Snipaste_2024-12-09_18-23-18.png" width="250px">
</figure>
</p>
<p>（2）第四步，选择第二个，并点击Manage</p>
<figure><img src="/images/KVM/Snipaste_2024-12-09_18-23-32.png" width="50%">
</figure>

<p>（3）新建一个存储池（不创建也可以，这样会安装到默认的位置（ /var/lib/libvirt/images））</p>
<p><figure><img src="/images/KVM/Snipaste_2024-12-09_18-25-52.png" width="350px">
</figure>

<figure><img src="/images/KVM/dizhi.png" width="300px">
</figure>
</p>
<p>目标路径设置为/root/KVM</p>
<p>（4）创建虚拟磁盘（磁盘会在存储池的指定目录下），我将名称命名为windows7a</p>
<figure><img src="/images/KVM/Snipaste_2024-12-09_18-27-57.png" width="67%">
</figure>

<p>（4）点击完成，回到第5步，将虚拟机名称命名为windows7</p>
<figure><img src="/images/KVM/Snipaste_2024-12-09_18-29-31.png" width="50%">
</figure>

<h5 id="33-win7客户机配置">3.3 win7客户机配置</h5>
<p>（1）上一步点击完成后，不要直接安装，要先进行虚拟机配置，安装后再配置可能会出现问题，按照下图依次进行配置，每配置一项，点一次应用</p>
<p><figure><img src="/images/KVM/peizhi1.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi2.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi3.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi4.png" width="380px">
</figure>
</p>
<p>（2）添加Virtio-win镜像文件</p>
<p><figure><img src="/images/KVM/peizhi6.png" width="50%">
</figure>

<figure><img src="/images/KVM/peizhi7.png" width="50%">
</figure>
</p>
<p>（3）安装驱动，两个驱动都要安装，重复两遍即可</p>
<p><figure><img src="/images/KVM/peizhi8.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi9.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi10.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi11.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi12.png" width="380px">
</figure>
</p>
<p>（4）慢慢等Windows安装完毕，开机后准备进行驱动激活程序。注意：安装完毕后，虚拟机不能关闭（因为虚拟机关闭后，配置文件的编辑可能会失败，会出现下次无法开启虚拟机，例如虚拟机开启时报错）。</p>
<p>在虚拟机开机的情况下打开虚拟机配置文件，用gedit打开，文件位置是/etc/libvirt/qemu</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gedit /etc/libvirt/qemu/windows7.xml
</span></span></code></pre></div><figure><img src="/images/KVM/peizhi13.png" width="50%">
</figure>

<p>然后将下列代码插入到<device>列表的最后一行，保存后关闭</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&lt;channel <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;unix&#39;</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   &lt;<span class="nb">source</span> <span class="nv">mode</span><span class="o">=</span><span class="s1">&#39;bind&#39;</span>/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   &lt;target <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span> <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;org.qemu.guest_agent.0&#39;</span>/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   &lt;address <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;virtio-serial&#39;</span> <span class="nv">controller</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="nv">port</span><span class="o">=</span><span class="s1">&#39;2&#39;</span>/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> &lt;/channel&gt;
</span></span></code></pre></div><figure><img src="/images/KVM/peizhi14.png" width="60%">
</figure>

<p>（5）下面进入虚拟机内部操作，如果虚拟机没有网络请不要着急，按照下图所示，一步一步操作即可</p>
<p>首先打开设备管理器，看到如下图所示，有两个PCI和一个网络驱动没有安装，安装步骤如图所示</p>
<p><figure><img src="/images/KVM/peizhi15.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi16.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi17.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi18.png" width="380px">
</figure>
</p>
<p>其他两个步骤相同，只是改变文件夹，分别在Balloon文件夹安装PCI设备驱动，以及在Netkvm文件夹中安装网络设备驱动</p>
<p><figure><img src="/images/KVM/peizhi19.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi20.png" width="380px">
</figure>
</p>
<p>安装完毕后可以看到下图所示</p>
<p><figure><img src="/images/KVM/peizhi21.png" width="380px">
</figure>

<figure><img src="/images/KVM/peizhi22.png" width="380px">
</figure>
</p>
<p>（6）最后，安装qemu，如下图所示，在virtio-win磁盘下，找到guest-agent文件下的qemu-ga-64文件安装。安装完毕后，整个安装过程就完毕了，后续就是验证是否安装成功。</p>
<figure><img src="/images/KVM/peizhi23.png" width="50%">
</figure>

<h5 id="34-验证步骤">3.4 验证步骤</h5>
<p>（1）通过命令行查看客户机、关闭客户机</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#以下代码需要将代码的windows7改为自己设置的名称</span>
</span></span><span class="line"><span class="cl"><span class="c1">#查看客户机</span>
</span></span><span class="line"><span class="cl">sudo virsh list --all
</span></span><span class="line"><span class="cl"><span class="c1">#关闭客户机</span>
</span></span><span class="line"><span class="cl">sudo virsh shutdown windows7
</span></span></code></pre></div><p><figure><img src="/images/KVM/Snipaste_2024-12-09_20-50-09.png" width="50%">
</figure>

<figure><img src="/images/KVM/Snipaste_2024-12-09_20-50-35.png" width="50%">
</figure>
</p>
<p>（2）进行开机，然后等虚拟机启动后，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#开机</span>
</span></span><span class="line"><span class="cl">virsh start windows7
</span></span><span class="line"><span class="cl"><span class="c1">#终端检测</span>
</span></span><span class="line"><span class="cl">virsh qemu-agent-command windows7 <span class="s1">&#39;{&#34;execute&#34;:&#34;guest-ping&#34;}&#39;</span>
</span></span></code></pre></div><p>如果返回如下图所示，则安装成功。</p>
<figure><img src="/images/KVM/Snipaste_2024-12-09_20-57-58.png" width="50%">
</figure>

<p>注意，如果这个命令如果报错，先不要怀疑自己安装出问题，这可能是正常现象，许多人都遇到过这个问题，请重启一下你的物理主机（ubuntu），物理主机重启后应该就没问题了，如果重启后还报错，请仔细检测全程安装步骤</p>
<h5 id="35-程序在桌面的窗口可视化">3.5 程序在桌面的窗口可视化</h5>
<p>当程序成功在任务管理器的进程列表时，很有可能是看不到程序窗口的，到时候可能会怀疑程序到底是不是正常按照自己的指令运行了，如下图所示（程序注入成功，但是看不到记事本窗口）：</p>
<p>这种情况下，只需要在设备管理器的“服务”选项找到qemu-guest-agent选项，按照下图所示操作即可</p>
<p><figure><img src="/images/KVM/peizhi24.png" width="67%">
</figure>

<figure><img src="/images/KVM/peizhi25.png" width="67%">
</figure>
</p>
<p>然后再次运行如下图命令，就可以看到窗口了</p>

</div>
    <div class="post__footer">
      
        <span><a class="category" href="/categories/blog/">Blog</a></span>


      

      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Chenxi Dang
        2025
      
    </li>
    
      <li class="footer__item">
        <a
          class="link"
          href="/imprint/"
          
          title=""
        >
          imprint
        </a>
      </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.9531b4a2217a70c5a1fce89c1f81c9ebbdd586708fcd4130b417320c7230c8d6.js"
    integrity="sha256-lTG0oiF6cMWh/OicH4HJ673VhnCPzUEwtBcyDHIwyNY="
    crossorigin="anonymous"
  ></script></body>
</html>
